(()=>{var f=Object.defineProperty,A=Object.prototype.hasOwnProperty,H=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports),E=t=>f(t,"__esModule",{value:!0}),z=(t,e)=>{if(E(t),typeof e=="object"||typeof e=="function")for(let i in e)!A.call(t,i)&&i!=="default"&&f(t,i,{get:()=>e[i],enumerable:!0});return t},W=t=>t&&t.__esModule?t:z(f({},"default",{value:t,enumerable:!0}),t);var D=H(x=>{var b=Object.defineProperty,I=t=>b(t,"__esModule",{value:!0}),B=(t,e)=>{I(t);for(var i in e)b(t,i,{get:e[i],enumerable:!0})};class a{constructor(t){t==null&&console.error("frame must be set on view"),this.repaint=this.repaint.bind(this),this.paint=this.paint.bind(this),this.getPointInView=this.getPointInView.bind(this),this.frame=t,this.subviews=[],this.clickable=!0,this.hidden=!1,this.backgroundColor=void 0,this.superview=void 0,this.strokeColor=void 0,this.animation=void 0}getFrame(){return this.frame}setSuperview(t){this.superview=t}viewDidAppearBase(){this.viewDidAppear(),this.subviews.forEach(t=>t.viewDidAppearBase())}viewDidAppear(){}viewDidDisappear(){}addSubview(t){if(t.hasSuperview()){console.error("Cant add subview already within another view ",t);return}t.setSuperview(this),this.subviews.push(t),a.isAdded(this)&&(this.viewDidAppearBase(),this.repaint())}insertViewAtBottom(t){t.setSuperview(this),this.subviews.unshift(t),a.isAdded(this)&&(this.viewDidAppearBase(),this.repaint())}removeFromSuperview(){this.superview.removeView(this),this.superview=void 0}hasSuperview(){return this.superview!==void 0}removeView(t){for(let e=0,i=this.subviews.length;e<i;e++)if(t===this.subviews[e]){this.removeSubviewAtIndex(e),t.viewDidDisappear();return}}removeSubviewAtIndex(t){this.subviews.splice(t,1)}animate(t,e,i,s=!1){this.animation={func:e,duration:t,onComplete:i,start:void 0}}isEventInside(t){return this.isPointInside(t.point.x,t.point.y)}isPointInside(t,e){return this.frame.x<=t&&t<=this.frame.x+this.frame.width&&this.frame.y<=e&&e<=this.frame.y+this.frame.height}getPointInView(t,e){const i={x:t,y:e};let s=this;for(;s!=null;)i.x-=s.frame.x,i.y-=s.frame.y,s=s.superview;return i}onMousedown(t){const e={...t.point};for(let i=0,s=this.subviews.length;i<s;i++){const o=this.subviews[this.subviews.length-i-1];o.clickable&&!o.hidden&&!t.defaultPrevented&&o.isEventInside(t)&&(t.point={x:e.x-o.frame.x,y:e.y-o.frame.y},o.onMousedown(t),t.point={...e})}}repaint(){if(!this.hasSuperview()){console.error("cant repaint without superview");return}this.superview.repaint()}paint(t,e){}paintBase(t,e){if(this.hidden)return;this.animation!==void 0&&this.handleAnimation(e);const i=this.frame.x!==0||this.frame.y!==0;i&&(t.ctx.save(),t.ctx.translate(this.frame.x,this.frame.y)),this.backgroundColor!=null&&t.paintRect(0,0,this.frame.width,this.frame.height,this.backgroundColor),this.strokeColor!==void 0&&t.drawRect(0,0,this.frame.width,this.frame.height,this.strokeColor),this.paint(t,e);for(let s=0,o=this.subviews.length;s<o;s++){const h=this.subviews[s];h.paintBase(t,e)}i&&t.ctx.restore()}handleAnimation(t){this.animation.start||(this.animation.start=t);const e=Math.round(t-this.animation.start)/this.animation.duration,i=Math.min(Math.max(e,0),1);this.animation.func(i),e>1&&(this.animation.loop?this.animation.start=t:(this.animation.onComplete(),this.animation=void 0))}getDOMElement(){if(!this.hasSuperview()){console.error("Cannot get DOM element before view has appeared");return}return this.superview.getDOMElement()}static isAdded(t){return t instanceof S?!0:t==null?!1:a.isAdded(t.superview)}}class S extends a{constructor(t,e){super(t);this.canvas=e,this.actuallyRepaint=this.actuallyRepaint.bind(this),this.repaint=this.repaint.bind(this)}reset(){}repaint(){window.requestAnimationFrame(this.actuallyRepaint)}actuallyRepaint(t){this.canvas.clear(),this.paintBase(this.canvas,t)}canvasSizeChanged(t,e){this.frame.width=t,this.frame.height=e}getDOMElement(){return this.canvas.domCanvas}}class P{constructor(t,e="auto"){this.onMousedown=this.onMousedown.bind(this),typeof t=="string"?this.domCanvas=document.getElementById(t):this.domCanvas=t,e=="auto"&&(e={width:this.domCanvas.offsetWidth,height:this.domCanvas.offsetHeight}),this.scaleFactor=2,this.ctx=this.domCanvas.getContext("2d"),this.rootview=new S({x:0,y:0,...e},this),this.setFrame(e.width,e.height),this.domCanvas.addEventListener("mousedown",this.onMousedown)}onMousedown(t){t.point={x:t.layerX,y:t.layerY},this.rootview.isEventInside(t)&&this.rootview.onMousedown(t)}getFrame(){return{x:0,y:0,width:Math.ceil(this.domCanvas.width/this.scaleFactor),height:Math.ceil(this.domCanvas.height/this.scaleFactor)}}setFrame(t,e){const i=this.ctx.font,s=this.ctx.fillStyle,o=this.ctx.strokeStyle;this.domCanvas.style.width=t,this.domCanvas.style.height=e,this.domCanvas.width=Math.ceil(t*this.scaleFactor),this.domCanvas.height=Math.ceil(e*this.scaleFactor),this.ctx.scale(this.scaleFactor,this.scaleFactor),this.ctx.font=i,this.ctx.fillStyle=s,this.ctx.strokeStyle=o,this.rootview.canvasSizeChanged(t,e)}paintRect(t,e,i,s,o){this.ctx.fillStyle=o,this.ctx.fillRect(t,e,i,s)}drawRect(t,e,i,s,o,h=2){this.ctx.lineWidth=h,this.ctx.strokeStyle=o,this.ctx.strokeRect(t,e,i,s)}beginLine(t,e=1,i="butt"){this.ctx.lineWidth=e,this.ctx.strokeStyle=t,this.ctx.lineCap=i,this.ctx.beginPath()}drawHorizontalLine(t,e,i){this.ctx.moveTo(t,i),this.ctx.lineTo(e,i)}drawLine(t,e,i,s,o){const h=Math.cos(this.degToRad(o)),n=Math.sin(this.degToRad(o));this.ctx.moveTo(t+i*h,e+i*n),this.ctx.lineTo(t+s*h,e+s*n)}degToRad(t){return t*Math.PI/180}drawVerticalLine(t,e,i){this.ctx.moveTo(t,e),this.ctx.lineTo(t,i)}endLine(){this.ctx.stroke()}hugeText(){this.ctx.setFont("bold 144px Helvetica")}boldText(){this.setFont("bold 14px Helvetica")}normalText(){this.setFont()}normalTextWithSize(t){this.setFont(`${t}px Helvetica`)}setFont(t="14px Helvetica"){this.ctx.font=t}textShadow(t,e){this.ctx.shadowColor=e,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=t}drawText(t,e,i,s="start",o){this.ctx.fillStyle=o,this.ctx.textAlign=s,this.ctx.fillText(i,t,e)}drawCanvas(t,e,i){const s=t.getFrame();this.ctx.drawImage(t.domCanvas,e,i,s.width,s.height,e,i,s.width,s.height)}clear(){this.ctx.clearRect(0,0,this.domCanvas.width,this.domCanvas.height)}}const u={x:8,y:20},y={};class M{constructor(t,e,i){this.height=t,this.getBackgroundColor=e,this.getTextColor=i}paintCell(t,e,i,s,o,h,n=v.DEFAULT){if(t.paintRect(o.x,o.y,s,this.height,this.getBackgroundColor(e,i,n)),h.length==0)return;const r=M.getTextWidth(t.ctx,h);r>s-u.x*2?t.drawText(o.x+u.x,u.y+o.y,h,"start",this.getTextColor()):t.drawText(-u.x+o.x+s,u.y+o.y,h,"end",this.getTextColor())}static getTextWidth(t,e){let i=y[e.length];if(i==null){const s=t.measureText(e);return y[e.length]=s.width,s.width}return i}}const v={DEFAULT:"DEFAULT",SELECTED:"SELECTED",ACTIVE:"ACTIVE"};class V extends a{constructor(t,e,i,s,o,h){super(t);this.moveTo=this.moveTo.bind(this),this.dataSupplier=e,this.contentWidth=i,this.xOffset=0,this.yOffset=0,this.cellHeight=s,this.selectedRows={},this.tmpSelectedRows={},this.active={x:0,y:0},this.onActiveChange=h,this.shownRows={y1:0,y2:0},this.shownCols={x1:0,x2:0},this.didMove=()=>{},this.cache={},this.inFocus=!1,this.isMultiSelect=o,this.cellPainter=new M(this.cellHeight,e.getCellBackgroundColor,e.getCellTextColor),this.lineColor=e.getSeparatorColor()}resetCache(){this.cache.maxXOffset=void 0,this.cache.minXOffset=void 0,this.cache.columnLength=void 0}setDidMove(t){this.didMove=t}getPageHeight(){return Math.ceil(this.frame.height/this.cellHeight)}getNumberOfRows(){return this.dataSupplier.getNumberOfRows()}getNumberOfColumns(){return this.dataSupplier.getNumberOfColumns()}getContentSize(){return{width:this.contentWidth,height:this.getNumberOfRows()*this.cellHeight}}getNumberOfVisibleColumns(){const t=0;for(let e=0;e<this.dataSupplier.getNumberOfColumns();e++){const i=this.dataSupplier.getColumnData();i.visible&&t++}return t}getColumnWithIndex(t){return this.dataSupplier.getColumnData(t)}getCell(t,e){return this.dataSupplier.getText(t,e)}focused(){this.inFocus=!0,this.superview!==void 0&&this.repaint()}blurred(){this.inFocus=!1,this.superview!==void 0&&this.repaint()}setActive(t,e){this.active={x:t,y:e},this.onActiveChange(t,e,this.outOfFrameDelta(t,e))}moveDown(){this.move(0,1)}moveUp(){this.move(0,-1)}moveLeft(){this.move(-1,0)}moveRight(){this.move(1,0)}move(t,e){this.moveTo(this.xOffset+t,this.yOffset+e)}moveToRow(t){this.moveTo(this.xOffset,t)}moveToCol(t){this.moveTo(t,this.yOffset)}moveTo(t,e){this.xOffset=t,this.yOffset=e}moveActiveDown(){this.moveActive(0,1)}moveActiveUp(){this.moveActive(0,-1)}moveActiveLeft(){this.moveActive(-1,0)}moveActiveRight(){this.moveActive(1,0)}moveActive(t,e){let i=this.active.x+t;t!=0&&(i=this.getNextVisibleColumnIndex(this.active.x,t>0?1:-1)),this.moveActiveTo(i,this.active.y+e)}moveActiveTo(t,e){const i=Math.max(0,this.getNumberOfRows()-1),s=Math.max(0,this.getNumberOfColumns()-1);this.setActive(Math.min(Math.max(0,t),s),Math.min(Math.max(0,e),i)),this.repaint()}getNextVisibleColumnIndex(t,e=1){let i=0,s;do i+=e,s=this.getColumnWithIndex(t+i);while(s!==void 0&&!s.visible);return s===void 0||!s.visible?t:t+i}updateSelectedFromTmp(t,e,i=!1){i||(this.selectedRows={});const s=Math.min(t,e),o=Math.max(t,e);for(let h=s;h<=o;h++)this.isSelected(h)?this.selectedRows[h]=1:this.selectedRows[h]=void 0;this.tmpSelectedRows={},this.repaint()}tmpSelectRow(t,e,i=!1){this.setActive(t,e),this.tmpSelectRowRange(e,e,i)}tmpSelectRowRange(t,e,i=!1){i||(this.selectedRows={}),this.tmpSelectedRows={};const s=Math.min(t,e),o=Math.max(t,e);for(let h=s;h<=o;h++)this.tmpSelectedRows[h]=1;this.repaint()}selectRow(t,e,i=!1){i||(this.selectedRows={}),this.selectedRows[e]=1,this.repaint()}deselect(t,e,i=!1){this.setActive(t,e),i?this.selectedRows[e]=void 0:this.selectedRows={},this.repaint()}isSelected(t){return(this.selectedRows[t]||0)+(this.tmpSelectedRows[t]||0)==1}outOfFrameDelta(t,e){if(e<this.yOffset&&this.yOffset>0)return{x:0,y:e-this.yOffset};const i=this.getPageHeight()+this.yOffset;return e>i-3?{x:0,y:e-i+3}:t<this.shownCols.x1+1?{x:t-this.shownCols.x1,y:0}:t>this.shownCols.x2-1?{x:t-this.shownCols.x2+1,y:0}:void 0}isActive(t,e){return this.active.x==t&&this.active.y==e}paint(t,e){let i={x:0,y:0};const s=Math.min(this.yOffset+this.getPageHeight()+1,this.getNumberOfRows());let o;t.normalText(),t.beginLine(this.lineColor);let h=!0;for(let n=this.yOffset;n<s;n++){for(let r=this.xOffset,d=this.getNumberOfColumns();r<d;r++){const T=this.dataSupplier.getText(r,n),p=this.dataSupplier.getColumnData(r);if(!p.visible)continue;if(this.cellPainter.paintCell(t,n,r,p.width,i,T,this.getCellStatus(n,r)),h&&this.paintColumnSeparator(t,i.x,0,this.frame.height),i.x+=p.width,i.x>this.frame.width){o=r;break}}h&&this.paintColumnSeparator(t,i.x,0,this.frame.height),this.paintRowSeparator(t,i.y),n==s-1&&i.x<this.frame.width&&t.paintRect(i.x,0,this.frame.width-i.x,this.frame.height,"white"),i={x:0,y:i.y+this.cellHeight},h=!1}this.paintRowSeparator(t,i.y),this.shownRows={y1:this.yOffset,y2:s},this.shownCols={x1:this.xOffset,x2:o},t.endLine()}getCellStatus(t,e){return this.isActive(e,t)?v.ACTIVE:this.isSelected(t)?v.SELECTED:v.DEFAULT}paintRowSeparator(t,e){t.drawHorizontalLine(0,t.getFrame().width,e+.5)}paintColumnSeparator(t,e,i,s){t.drawVerticalLine(e+.5,i,s)}}class L extends a{constructor(t,e,i){super(t);this.canvasMouseMove=this.canvasMouseMove.bind(this),this.canvasMouseUp=this.canvasMouseUp.bind(this),this.setHandleRatio=this.setHandleRatio.bind(this),this.handleLength=50,this.location=0,this.getScrollColor=i,this.cursor={down:!1,handleDist:0},this.handler=e,this.handle=new a(this.getHandleFrame(this.handleLength)),this.handle.backgroundColor=this.getHandleBackgroundColor(),this.addSubview(this.handle),this.hidden=!1,this.clickable=!0}getLocationFromEvent(t){console.error("abstract function")}getLength(){console.error("abstract function")}getHandleFrame(){console.error("abstract function")}setLocation(t){this.location=t}setHandleLength(t){this.handleLength=t,this.handle.frame=this.getHandleFrame(t),this.hidden=this.handleLength>=this.getLength()}setHandleRatio(t){const e=this.getLength()*Math.max(Math.min(t,1),.1);this.setHandleLength(e)}getHandleBackgroundColor(){return this.getScrollColor(this.cursor.down)}onMousedown(t){t.button==0&&(this.cursor.down=!0,this.cursor.handleDist=this.location-this.getLocationFromEvent(t),this.handle.backgroundColor=this.getHandleBackgroundColor(),this.repaint(),t.preventDefault(),window.addEventListener("mousemove",this.canvasMouseMove),window.addEventListener("mouseup",this.canvasMouseUp))}canvasMouseMove(t){if(!this.cursor.down||t.button!=0)return;const e=this.getLocationFromEvent(t),i=e-(this.location-this.cursor.handleDist),s=this.limitLocation(this.location+i);this.setLocation(s),this.handler(this.getProgress(this.location)),this.repaint(),t.preventDefault()}canvasMouseUp(t){t.button==0&&(this.cursor.down=!1,this.handle.backgroundColor=this.getHandleBackgroundColor(),this.repaint(),t.preventDefault(),window.removeEventListener("mousemove",this.canvasMouseMove),window.removeEventListener("mouseup",this.canvasMouseUp))}limitLocation(t){const e=Math.max(0,t),i=Math.min(e,this.getLength()-this.handleLength);return i}getProgress(t=this.location){return this.getLength()===this.handleLength?0:t/(this.getLength()-this.handleLength)}setProgress(t){this.setLocation(t*(this.getLength()-this.handleLength))}addDelta(t){const e=t+this.getProgress(),i=Math.min(1,Math.max(0,e)),s=(this.getLength()-this.handleLength)*i;return this.setLocation(s),i}}const l=2;class N extends L{getLocationFromEvent(t){return t.x}getLength(){return this.frame.width-l*2}getHandleFrame(t){return{x:this.location+l,y:l,width:t,height:this.frame.height-l*2}}setLocation(t){super.setLocation(t),this.handle.frame.x=t+l}}class U extends L{getLocationFromEvent(t){return t.y}getLength(){return this.frame.height-l*2}getHandleFrame(t){return{x:l,y:this.location+l,width:this.frame.width-l*2,height:t}}setLocation(t){super.setLocation(t),this.handle.frame.y=t+l}}class K extends a{constructor(t,e,i,s,o){super(t);this.scrolledHorizontal=this.scrolledHorizontal.bind(this),this.scrolledVertical=this.scrolledVertical.bind(this),this.onWheel=this.onWheel.bind(this),this.SCROLL_WIDTH=i,this.contentSize=e,this.delegate=s;const h=new U(this.getVerticalScrollFrame(t.width,t.height),this.scrolledVertical,o),n=new N(this.getHorizontalScrollFrame(t.width,t.height),this.scrolledHorizontal,o);this.vertical=h,this.horizontal=n,this.addSubview(n),this.addSubview(h),this.resized(this.contentSize)}viewDidAppear(){const t=this.getDOMElement();t.addEventListener("wheel",this.onWheel)}resized(t){const e=this.frame.height/this.contentSize.height,i=this.frame.width/this.contentSize.width;this.horizontal.hidden=i>1,this.vertical.hidden=e>1,this.horizontal.hidden&&this.horizontal.location>0&&(this.horizontal.setLocation(0),this.horizontal.handler(this.horizontal.getProgress(this.horizontal.location))),this.vertical.hidden&&this.vertical.location>0&&(this.vertical.setLocation(0),this.vertical.handler(this.vertical.getProgress(this.vertical.location))),this.horizontal.setHandleRatio(i),this.vertical.setHandleRatio(e);const s=this.frame.height-(this.horizontal.hidden?0:this.horizontal.getFrame().height),o=this.frame.width-(this.vertical.hidden?0:this.vertical.getFrame().width);this.vertical.frame=this.getVerticalScrollFrame(this.frame.width,s),this.horizontal.frame=this.getHorizontalScrollFrame(o,this.frame.height),this.contentSize=t}onWheel(t){const e=.1;if(t.deltaY!=0){const s=t.deltaY*e/this.frame.height;var i=this.vertical.addDelta(s);this.scrolledVertical(i)}if(t.deltaX!=0){const s=t.deltaX*e/this.frame.width;var i=this.horizontal.addDelta(s);this.scrolledHorizontal(i)}this.repaint(),t.preventDefault()}setScroll(t,e){t!=null&&this.horizontal.setProgress(t),e!=null&&this.vertical.setProgress(e)}scrolledHorizontal(t){this.delegate(t,void 0)}scrolledVertical(t){this.delegate(void 0,t)}getVerticalScrollFrame(t,e){return{x:t-this.SCROLL_WIDTH,y:0,width:this.SCROLL_WIDTH,height:e}}getHorizontalScrollFrame(t,e){return{x:0,y:e-this.SCROLL_WIDTH,width:t,height:this.SCROLL_WIDTH}}}const X=32,Y=33,_=34,$=13,j=37,q=38,G=39,J=40,Q=67;class Z{constructor(t,e){this.canvasOnClick=this.canvasOnClick.bind(this),this.canvasMouseMove=this.canvasMouseMove.bind(this),this.canvasMouseUp=this.canvasMouseUp.bind(this),this.canvasKeyDown=this.canvasKeyDown.bind(this),this.getCellForEvent=this.getCellForEvent.bind(this),this.onFocus=this.onFocus.bind(this),this.onBlur=this.onBlur.bind(this),t.onMousedown=this.canvasOnClick;const i=t.viewDidAppear;t.viewDidAppear=()=>{this.viewDidAppear(),i()},this.table=t,this.menuDelegate=e,this.cursor={down:!1,start:{x:0,y:0},movedOutside:!1}}viewDidAppear(){this.focusOnCanvas=()=>canvas.focus(),canvas.oncontextmenu=t=>!1,canvas.addEventListener("keydown",this.canvasKeyDown),canvas.addEventListener("focus",this.onFocus),canvas.addEventListener("blur",this.onBlur),this.reset=()=>{canvs.removeEventListener("keydown",this.canvasKeyDown),canvas.removeEventListener("focus",this.onFocus),canvas.removeEventListener("blur",this.onBlur)}}showContextMenu(t,e){this.menuDelegate.show(t,e)}hideContextMenu(){this.menuDelegate.hide()}onFocus(){this.table.focused()}onBlur(){this.table.blurred()}toggleSelect(t,e){this.table.isSelected(t.y)?this.table.deselect(t.x,t.y,e):this.table.selectRow(t.x,t.y,e)}canvasOnClick(t){this.table.inFocus||this.focusOnCanvas(),t.button==0?this.leftClickDown(t):t.button==2&&this.rightClickDown(t),window.addEventListener("mousemove",this.canvasMouseMove),window.addEventListener("mouseup",this.canvasMouseUp)}canvasMouseMove(t){t.point=this.table.getPointInView(t.layerX,t.layerY);const e=this.getCellForEvent(t);t.button==0&&this.leftClickMove(t,e)}canvasMouseUp(t){const e=this.getCellForEvent(t);t.button==0&&this.cursor.down?(this.leftClickUp(t,e),this.cursor.down=!1):t.button==2&&this.rightClickUp(t,e),window.removeEventListener("mousemove",this.canvasMouseMove),window.removeEventListener("mouseup",this.canvasMouseUp)}leftClickDown(t){const e=this.getCellForEvent(t);this.cursor.down=!0,this.cursor.movedOutside=!1,this.cursor.start=e,this.table.tmpSelectRow(this.cursor.start.x,this.cursor.start.y,this.table.isMultiSelect&&t.ctrlKey),this.hideContextMenu(),t.preventDefault()}leftClickMove(t,e){(e.x!==this.cursor.start.x||e.y!==this.cursor.start.y)&&(this.cursor.movedOutside=!0),this.table.isMultiSelect?this.table.tmpSelectRowRange(this.cursor.start.y,e.y,t.ctrlKey):this.table.tmpSelectRow(e.x,e.y,!1)}leftClickUp(t,e){if(!this.cursor.movedOutside){const i=this.table.getColumnWithIndex(e.x);i&&i.onClick&&i.onClick(this.table.getRowWithIndex(e.y))}this.table.updateSelectedFromTmp(this.cursor.start.y,e.y,t.ctrlKey)}rightClickDown(t){const e=this.getCellForEvent(t);this.table.isSelected(e.y)||(console.log("rc select row"),this.table.tmpSelectedRows[this.table.cells[e.y]]=void 0,this.table.selectRow(e.x,e.y,this.table.isMultiSelect&&t.ctrlKey)),console.log("rc select cell ",e),this.table.active=e,this.hideContextMenu(),this.showContextMenu(t.point.x,t.point.y),t.preventDefault()}rightClickMove(t){}rightClickUp(t,e){}canvasKeyDown(t){let e=!1;switch(t.keyCode){case X:this.toggleSelect(this.table.active,t.ctrlKey&&this.table.isMultiSelect),e=!0;break;case Y:this.table.moveActive(0,-this.table.getPageHeight()),e=!0;break;case _:this.table.moveActive(0,this.table.getPageHeight()),e=!0;break;case $:{const i=this.table.active;if(i.x>=0&&i.y>=0){const s=this.table.getColumnWithIndex(i.x),o=this.table.getRowWithIndex(i.y);s.onClick!==void 0&&s.mapper(o)!==void 0&&s.onClick(this.table.getRowWithIndex(i.y))}e=!0;break}case j:this.table.moveActiveLeft(),e=!0;break;case q:this.table.moveActiveUp(),e=!0;break;case G:this.table.moveActiveRight(),e=!0;break;case J:this.table.moveActiveDown(),e=!0;break;default:}t.ctrlKey&&(t.keyCode===Q?(this.copy(t.shiftKey),e=!0):t.key==="a"&&(this.table.isMultiSelect&&(console.log("select all"),this.table.tmpSelectRowRange(0,this.table.getNumberOfRows()-1,!1),this.table.updateSelectedFromTmp(0,this.table.getNumberOfRows()-1,!1)),e=!0)),e&&t.preventDefault()}copy(t,e=!1){const i=this.table.getSelectedRows(),s=this.table.active,o=this.table.getColumnWithIndex(s.x),h=this.table.getRowWithIndex(s.y);let n;if(i.length>0&&t){const r=this.table.columns.filter(d=>d.visible);n=r.map(d=>d.mapper(i)).join(`\r
`)}else n=o.mapper(h)||" ";console.log("copy ",`${n}`.substr(0,50)),this.inputElement.value=n,this.inputElement.select(),document.execCommand("Copy"),this.focusOnCanvas()}getCellForEvent(t){const e=t.point?t.point.x:t.layerX,i=t.point?t.point.y:t.layerY,s=this.table.dataSupplier.getNumberOfRows(),o=this.getColumnIndexForPosition(e),h=Math.floor(i/this.table.cellHeight);return{x:o+this.table.xOffset,y:Math.min(s-1,h+this.table.yOffset)}}getColumnIndexForPosition(t){let e=0;for(let i=this.table.xOffset,s=this.table.getNumberOfColumns();i<s;i++){const o=this.table.getColumnWithIndex(i);if(!o.visible)continue;const h=e+o.width;if(e<=t&&t<=h)return i-this.table.xOffset;e=h}return-1}}const R=[...Array(26)].map((t,e)=>String.fromCharCode(e+65));class tt extends a{constructor(t,e,i){super(t);this.onMousemove=this.onMousemove.bind(this),this.onMouseup=this.onMouseup.bind(this),this.dataSupplier=e,this.onColumnSizeChange=i,this.xOffset=0,this.cursor={down:!1,start:void 0,column:void 0}}moveTo(t){this.xOffset=t}onMousedown(t){const e=this.getColumnAtPoint(t.point.x);this.cursor.column=e,this.cursor.down=!0,this.cursor.start={...t.point},document.addEventListener("mousemove",this.onMousemove),document.addEventListener("mouseup",this.onMouseup),this.repaint()}onMousemove(t){const e=this.getPointInView(t.layerX,t.layerY),i=e.x-this.cursor.start.x;this.cursor.start=e,this.onColumnSizeChange(this.cursor.column,i),t.target.style.cursor="col-resize",this.repaint()}onMouseup(t){this.cursor.down=!1,this.cursor.column=void 0,t.target.style.cursor="default",document.removeEventListener("mousemove",this.onMousemove),document.removeEventListener("mouseup",this.onMouseup),this.repaint()}paint(t,e){let i=0;for(let s=this.xOffset,o=this.dataSupplier.getNumberOfColumns();s<o;s++){const h=this.dataSupplier.getColumnWidth(s);if(t.drawText(i+h/2,15,this.getText(s),"center","black"),i+=h,i>this.frame.width)break}}getColumnAtPoint(t){let e=0;for(let i=this.xOffset,s=this.dataSupplier.getNumberOfColumns();i<s;i++){const o=this.dataSupplier.getColumnWidth(i);if(e<t&&t<e+o)return i;e+=o}return}getText(t){const e=R.length,i=Math.floor(t/e),s=t%e,o=R[s];return i<=0?o:this.getText(i-1)+o}}class et extends a{constructor(t,e,i){super(t);this.numberOfRows=e,this.cellHeight=i,this.row=0}moveTo(t){this.row=t}paint(t,e){let i=0;for(let s=this.row;s<this.numberOfRows;s++)t.drawText(this.frame.width/2,i+this.cellHeight/2+4,s,"center","black"),i+=this.cellHeight}}const F=30,m=12,g=20,w=30;class C extends a{constructor(t,e){super(t);this.scrollviewDidScroll=this.scrollviewDidScroll.bind(this),this.onColumnSizeChange=this.onColumnSizeChange.bind(this),this.onActiveChange=this.onActiveChange.bind(this),this.dataSupplier=e,this.contentWidth=C.getColumnWidth(e);const i={x:w,y:g,width:t.width-w,height:t.height-g};this.columnHeader=new tt({x:w,y:0,width:i.width,height:g},e,this.onColumnSizeChange),this.rowHeader=new et({x:0,y:g,width:w,height:i.height},e.getNumberOfRows(),F),this.columnHeader.backgroundColor=e.getHeaderBackgroundColor(),this.rowHeader.backgroundColor=e.getHeaderBackgroundColor(),this.grid=new V(i,e,this.contentWidth,F,!0,this.onActiveChange),new Z(this.grid,{show:()=>{},hide:()=>{}}),this.scrollview=new K(i,this.grid.getContentSize(),m,this.scrollviewDidScroll,e.getScrollColor),this.scrollview.vertical.backgroundColor=e.getScrollBackgroundColor(),this.scrollview.horizontal.backgroundColor=e.getScrollBackgroundColor();const s=new a({x:t.width-m,y:t.height-m,width:m,height:m});s.clickable=!1,s.backgroundColor=e.getHeaderBackgroundColor(),this.addSubview(this.grid),this.addSubview(this.columnHeader),this.addSubview(this.rowHeader),this.addSubview(this.scrollview),this.addSubview(s),this.columnSpan=this.getColumnSpans(),this.rowSpan=this.getRowSpans(),this.delegate={selected:()=>{}}}scrollviewDidScroll(t,e){if(t!=null){const[i,s]=this.columnSpan,o=Math.floor((s-i)*t);this.grid.moveToCol(o),this.columnHeader.moveTo(o)}if(e!=null){const[i,s]=this.rowSpan,o=Math.floor((s-i)*e);this.grid.moveToRow(o),this.rowHeader.moveTo(o)}}onColumnSizeChange(t,e){let i=this.dataSupplier.getColumnWidth(t);i=Math.max(20,i+e),this.dataSupplier.setColumnWidth(t,i),this.contentWidth=C.getColumnWidth(this.dataSupplier),this.scrollview.resized(this.grid.getContentSize()),this.columnSpan=this.getColumnSpans()}onActiveChange(t,e,i){this.delegate.selected(t,e),i!==void 0&&(this.grid.move(i.x,i.y),this.columnHeader.moveTo(this.grid.xOffset||0),this.rowHeader.moveTo(this.grid.YOffset||0),this.scrollview.setScroll(this.grid.xOffset/this.columnSpan[1],this.grid.yOffset/this.rowSpan[1]))}getColumnSpans(){const t=50;let e=0,i=0,s=0;for(let o=0,h=this.dataSupplier.getNumberOfColumns();o<h;o++){const n=this.dataSupplier.getColumnData(o);if(n.visible){if((i=0)&&(i=o),e+this.frame.width>this.contentWidth+t&&s==0){s=o;break}e+=n.width}}return[i,s]}getRowSpans(){return[0,this.dataSupplier.getNumberOfRows()-this.grid.getPageHeight()+2]}static getColumnWidth(t){let e=0;for(let i=0,s=t.getNumberOfColumns();i<s;i++)e+=t.getColumnWidth(i);return e}}class O{getNumberOfColumns(){console.error("must implement in subclass")}getNumberOfRows(){console.error("must implement in subclass")}getColumnWidth(t){console.error("must implement in subclass")}setColumnWidth(t,e){console.error("must implement in subclass")}getColumnData(t){console.error("must implement in subclass")}getText(t,e){console.error("must implement in subclass")}getCellBackgroundColor(t,e,i){switch(i){case"DEFAULT":return t%2==0?"#F4F4F4":"#FFFFFF";case"SELECTED":return"#FFFFCC";case"ACTIVE":return"#FFAAAA"}}getSeparatorColor=()=>"#BBB";getCellTextColor=()=>"#000";getScrollBackgroundColor=()=>"#DDD";getScrollColor=t=>t?"#999":"#BBB";getHeaderBackgroundColor=()=>"#FFF";static spreadsheet(t,e){return new it(t,e)}}class it extends O{constructor(t,e){super();this.columns=t,this.cells=e}getNumberOfColumns(){return this.columns.length}getNumberOfRows(){return this.cells.length}getColumnWidth(t){return this.columns[t].width}setColumnWidth(t,e){this.columns[t].width=e}getColumnData(t){return this.columns[t]}getText(t,e){const i=this.cells[t][e];return i==null?"":i.formattedValue||i.value}}B(x,{Canvas:()=>P,DataModel:()=>O,TableView:()=>C})});const c=W(D()),st=new Array(2e3).fill(null).map((t,e)=>({title:`Column ${e}`,mapper:i=>`${i.a}${e}`,visible:!0,width:70}));let ot=0;const ht=new Array(2e3).fill(null).map(t=>new Array(2e3).fill(null).map((e,i)=>{const s=ot++;return{value:s,formattedValue:s}})),k=new c.Canvas("canvas","auto"),nt=new c.TableView(k.rootview.frame,c.DataModel.spreadsheet(st,ht));k.rootview.addSubview(nt);})();
